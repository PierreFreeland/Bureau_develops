version: '3.7'
x-app_common:
  &app_common
  build:
    context: ../../
    dockerfile: ops/test/Dockerfile
    args:
      BUNDLE_GEMS__ITG__FR: ${BUNDLE_GEMS__ITG__FR}
    cache_from:
      - goxygen-hubdev_app
  env_file:
    - app_env
    - app_env.secrets
  stdin_open: true
  tty: true
  volumes:
    - app_data:/app:cached
    - ./database.yml:/app/config/database.yml
  tmpfs:
    - /tmp
  command: /bin/sh -c 'rake db:drop; rake db:create && rake db:structure:load && rake db:fixtures:load && rake test ALL=yes BACKTRACE=yes'

services:
  app:
    << : *app_common
volumes:
  app_data:
    driver_opts:
      type: none
      device: "${PWD}/../../"
      o: bind

networks:
  default:
    external:
      name: plungy_default
